{% extends "find_pp2m/base_maps.html" %}
{% load bootstrap %}
{% load static %}

{% block title %}PP2M{% endblock %}


{% block content %}
    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    {{ journey_formset.media }}

    <form id="form-container" method="POST">
        <table width=100%><tbody>
            <tr>
                <td width="50%" align="center">Ville</td>
                <td width="10%" align="center">Personnes</td>
                <td width="30%" align="center">Mode de transport</td>
                <td width="10%" align="center"></td>
            </tr>
        </tbody></table>
        {% csrf_token %}
        {{journey_formset.management_form}}
        {% for form in journey_formset %}
            
            <table width=100% class="form-row" id={{form.initial.id}}><tbody>  <!--id={{form.initial.id}}-->
                {{ form.errors }}
                <tr>
                    <td width="50%" align="center" class="formcity">{{form.city}}</td>
                    <td width="10%" align="center">{{form.nb_people}}</td>
                    <td width="30%" align="center">{{form.conveyance}}</td>
                    <td width="10%" align="center"><button class="remove-form-row">-</button></td>
                </tr>
            </tbody></table>
        {% endfor %}
        <table id="lasttable" width=100%><tr>
            <td width="90%" colspan="3"></td>
            <td width="10%" align="center"><type="button" class="row_button" button id="add-form">+</button></td>
        </tr></table>
        <table id="params" width=100%>
            <tr height="10px"></tr>
            <tr>
                <td width="5%"></td>
                <td width="20%">Méthode</td>
                <td width="40%">{{param_form.method}}</td>
                <td width="35%"></td>
            </tr>
            <tr height="5px"></tr>
            <tr>
                <td width="5%"></td>
                <td width="20%">Critère</td>
                <td width="40%">{{param_form.criteria}}</td>
                <td width="35%"></td>
            </tr>
        </table>
        <table width=100% align="center">
            <tr>
                <td width=100% align="center"><input type="submit" value="Calculer" id="submit_button"/></td>
            </tr>
        </table>
        
    </form>

    <script type="text/javascript">
        window.onload = function(){
            let formCities = document.querySelectorAll(".formcity")
            formCities.forEach(function(formCity) {
                for (var i = 0; i < formCity.children.length; i++) {
                    formCity.children[i].style.width = "1px" 
                }
            });
        }
    </script>

    <script>
        let journeyForm = document.querySelectorAll(".form-row")
        let container = document.querySelector("#form-container")
        let lastTable = document.querySelector("#lasttable")
        let addButton = document.querySelector("#add-form")
        let totalForms = document.querySelector("#id_form-TOTAL_FORMS")

        let formNum = journeyForm.length-1
        addButton.addEventListener('click', addForm)

        function addForm(e){
            e.preventDefault()

            let newForm = journeyForm[0].cloneNode(true)
            let formRegex = RegExp(`form-(\\d){1}-`,'g')

            formNum++
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formNum}-`)
            container.insertBefore(newForm, lastTable)
            
            totalForms.setAttribute('value', `${formNum+1}`) 

            let oneSelect = newForm.querySelector(".select2-container")
            oneSelect.parentNode.removeChild(oneSelect)
            
        }
        
    </script>

    <script type='text/javascript'>
    function updateElementIndex(el, prefix, ndx) {
        var id_regex = new RegExp('(' + prefix + '-\\d+)');
        var replacement = prefix + '-' + ndx;
        if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
        if (el.id) el.id = el.id.replace(id_regex, replacement);
        if (el.name) el.name = el.name.replace(id_regex, replacement);
    }
    function cloneMore(selector, prefix) {
        var newElement = $(selector).clone(true);
        var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
        newElement.find(':input').each(function() {
            var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
            var id = 'id_' + name;
            $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
        });
        newElement.find('label').each(function() {
            var newFor = $(this).attr('for').replace('-' + (total-1) + '-','-' + total + '-');
            $(this).attr('for', newFor);
        });
        total++;
        $('#id_' + prefix + '-TOTAL_FORMS').val(total);
        $(selector).after(newElement);
    }
    function deleteForm(prefix, btn) {
        var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
        if (total > 1){
            btn.closest('.form-row').remove();
            var forms = $('.form-row');
            $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
            for (var i=0, formCount=forms.length; i<formCount; i++) {
                $(forms.get(i)).find(':input').each(function() {
                    updateElementIndex(this, prefix, i);
                });
            }
        }
        return false;
    }
    $(document).on('click', '.remove-form-row', function(e){
        e.preventDefault();
        deleteForm('form', $(this));
        return false;
    });
    $('#add_more').click(function() {
        cloneMore('.form-row:last', 'form');
    });
    </script>

{% endblock %}--!>




